# Multi-User Collaborative Document System
## Project Report

---

## Table of Contents

1. [Motivation & Approach](#1-motivation--approach)
2. [System Design & Technical Details](#2-system-design--technical-details)
3. [Evaluation](#3-evaluation)
4. [Artifact Description & Reproducibility](#4-artifact-description--reproducibility)
5. [Conclusion](#5-conclusion)

---

## 1. Motivation & Approach

### 1.1 Problem Statement

In modern collaborative work environments, teams need to edit documents simultaneously without conflicts, share access with fine-grained permissions, and communicate through contextual comments. Existing solutions like Google Docs and Notion have demonstrated the value of real-time collaboration, but building such systems presents significant technical challenges:

1. **Conflict Resolution**: Multiple users editing the same content simultaneously can lead to data conflicts and inconsistencies.
2. **Low Latency**: Users expect instant feedback when collaborating in real-time.
3. **Data Persistence**: Document state must be reliably saved and recovered.
4. **Access Control**: Organizations require granular permission management for sensitive documents.

### 1.2 Motivation

This project is motivated by the need to understand and implement the core technologies that power modern collaborative applications:

- **Educational Value**: Gain hands-on experience with CRDT (Conflict-free Replicated Data Types), WebSocket protocols, and distributed systems concepts.
- **Practical Application**: Build a functional system that can be deployed and used in real scenarios.
- **Full-Stack Integration**: Demonstrate the integration of modern frontend frameworks with backend services and real-time communication.

### 1.3 Approach Overview

Our approach combines proven technologies to create a robust collaborative document system:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        High-Level Architecture                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Frontend (Next.js)  â†â†’  Y-WebSocket  â†â†’  Backend (Go)        â”‚
â”‚         â†“                      â†“                â†“               â”‚
â”‚   TipTap Editor           Yjs CRDT         PostgreSQL          â”‚
â”‚   React Components        Real-time        Persistence          â”‚
â”‚                           Sync                                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Design Decisions**:

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Real-time Sync | Yjs (CRDT) | Automatic conflict resolution, proven library |
| Editor | TipTap | Extensible, Yjs integration built-in |
| Backend | Go + Gin | High performance, strong typing |
| Database | PostgreSQL | ACID compliance, JSON support |
| Frontend | Next.js 14 | Server-side rendering, modern React |

### 1.4 System Features Overview

æœ¬ç³»ç»Ÿæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š

#### 1.4.1 ç”¨æˆ·è®¤è¯ä¸è´¦æˆ·ç®¡ç†

| åŠŸèƒ½ | æè¿° |
|------|------|
| ç”¨æˆ·æ³¨å†Œ | é‚®ç®± + å¯†ç æ³¨å†Œï¼Œè‡ªåŠ¨åˆ›å»ºæ¬¢è¿æ–‡æ¡£ |
| ç”¨æˆ·ç™»å½• | JWT Token è®¤è¯ï¼Œ24å°æ—¶æœ‰æ•ˆæœŸ |
| å¯†ç ä¿®æ”¹ | éªŒè¯æ—§å¯†ç åæ›´æ–°æ–°å¯†ç  |
| å¿˜è®°å¯†ç  | å‘é€é‡ç½®é“¾æ¥ï¼ˆé¢„ç•™æ¥å£ï¼‰ |

#### 1.4.2 æ–‡æ¡£ç®¡ç†

| åŠŸèƒ½ | æè¿° |
|------|------|
| åˆ›å»ºæ–‡æ¡£ | ä¸€é”®åˆ›å»ºæ–°æ–‡æ¡£ï¼Œè‡ªåŠ¨è®¾ä¸º owner |
| ç¼–è¾‘æ–‡æ¡£ | å®æ—¶ä¿å­˜ï¼Œæ”¯æŒå¤šäººåŒæ—¶ç¼–è¾‘ |
| é‡å‘½å/åˆ é™¤ | å†…è”ç¼–è¾‘æ ‡é¢˜ï¼Œå¸¦ç¡®è®¤çš„åˆ é™¤æ“ä½œ |
| ç§»åŠ¨æ–‡æ¡£ | å°†æ–‡æ¡£ç§»åŠ¨åˆ°ä¸åŒæ–‡ä»¶å¤¹ |

#### 1.4.3 å¯Œæ–‡æœ¬ç¼–è¾‘å™¨

åŸºäº TipTap ç¼–è¾‘å™¨ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Toolbar: [B] [I] [U] [S] â”‚ [H1] [H2] [H3] â”‚ [â€¢] [1.] [â˜‘]   â”‚
â”‚          Bold Italic      â”‚ Headings       â”‚ Lists & Tasks  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- æ–‡æœ¬æ ¼å¼ï¼šç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€åˆ é™¤çº¿
- ç»“æ„å…ƒç´ ï¼šæ ‡é¢˜ (H1-H3)ã€æœ‰åºåˆ—è¡¨ã€æ— åºåˆ—è¡¨ã€ä»»åŠ¡åˆ—è¡¨

#### 1.4.4 å®æ—¶åä½œ

| åŠŸèƒ½ | æè¿° |
|------|------|
| å¤šäººåŒæ—¶ç¼–è¾‘ | æ— é™åˆ¶ç”¨æˆ·æ•°é‡åŒæ—¶ç¼–è¾‘åŒä¸€æ–‡æ¡£ |
| å®æ—¶å…‰æ ‡æ˜¾ç¤º | çœ‹åˆ°å…¶ä»–ç”¨æˆ·çš„å…‰æ ‡ä½ç½®å’Œé¢œè‰² |
| å³æ—¶åŒæ­¥ | æ›´æ”¹åœ¨ ~50ms å†…åŒæ­¥åˆ°å…¶ä»–ç”¨æˆ· |
| ç¦»çº¿æ”¯æŒ | æ–­ç½‘åç»§ç»­ç¼–è¾‘ï¼Œæ¢å¤åè‡ªåŠ¨åŒæ­¥ |

#### 1.4.5 æƒé™ç®¡ç†

| è§’è‰² | æŸ¥çœ‹ | è¯„è®º | ç¼–è¾‘ | åˆ é™¤ | ç®¡ç†æƒé™ |
|------|:----:|:----:|:----:|:----:|:--------:|
| view | âœ… | âŒ | âŒ | âŒ | âŒ |
| comment | âœ… | âœ… | âŒ | âŒ | âŒ |
| edit | âœ… | âœ… | âœ… | âŒ | âŒ |
| owner | âœ… | âœ… | âœ… | âœ… | âœ… |

åŠŸèƒ½åŒ…æ‹¬ï¼šé‚®ç®±é‚€è¯·ã€æƒé™ä¿®æ”¹ã€ç§»é™¤åä½œè€…ã€è®¿é—®è¯·æ±‚ä¸å®¡æ‰¹ã€‚

#### 1.4.6 è¯„è®ºç³»ç»Ÿ

| åŠŸèƒ½ | æè¿° |
|------|------|
| é€‰åŒºè¯„è®º | é€‰ä¸­æ–‡æœ¬åæ·»åŠ è¯„è®ºï¼Œè®°å½•ä½ç½® |
| è¯„è®ºå›å¤ | æ”¯æŒè¯„è®ºçº¿ç¨‹ï¼Œå½¢æˆè®¨è®º |
| è¯„è®ºè§£å†³ | å°†è¯„è®ºæ ‡è®°ä¸ºå·²è§£å†³ |
| åŒå‘å®šä½ | ç‚¹å‡»è¯„è®ºå®šä½åˆ°æ–‡æœ¬ï¼Œç‚¹å‡»é«˜äº®æ–‡æœ¬å®šä½åˆ°è¯„è®º |

#### 1.4.7 æ–‡ä»¶å¤¹ç®¡ç†

| åŠŸèƒ½ | æè¿° |
|------|------|
| å±‚çº§ç»“æ„ | æ”¯æŒæ— é™çº§æ–‡ä»¶å¤¹åµŒå¥— |
| æ ‘å½¢å¯¼èˆª | ä¾§è¾¹æ æ˜¾ç¤ºå®Œæ•´æ–‡ä»¶å¤¹å±‚çº§ |
| é¢åŒ…å±‘å¯¼èˆª | æ˜¾ç¤ºå½“å‰è·¯å¾„ï¼Œæ”¯æŒå¿«é€Ÿè·³è½¬ |
| è§†å›¾åˆ‡æ¢ | å¡ç‰‡è§†å›¾ / åˆ—è¡¨è§†å›¾ |

#### 1.4.8 åŠŸèƒ½æ€»ç»“

| æ¨¡å— | åŠŸèƒ½æ•° | çŠ¶æ€ |
|------|:------:|:----:|
| ç”¨æˆ·è®¤è¯ | 5 | âœ… |
| æ–‡æ¡£ç®¡ç† | 6 | âœ… |
| å¯Œæ–‡æœ¬ç¼–è¾‘ | 10+ | âœ… |
| å®æ—¶åä½œ | 5 | âœ… |
| æƒé™ç®¡ç† | 4 | âœ… |
| è¯„è®ºç³»ç»Ÿ | 6 | âœ… |
| æ–‡ä»¶å¤¹ç®¡ç† | 6 | âœ… |

### 1.5 Why CRDT Matters (ä¸ºä»€ä¹ˆ CRDT é‡è¦)

#### 1.5.1 åä½œç¼–è¾‘çš„æ ¸å¿ƒæŒ‘æˆ˜

å½“å¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘åŒä¸€æ–‡æ¡£æ—¶ï¼Œé¢ä¸´ç»å…¸çš„**å¹¶å‘å†²çªé—®é¢˜**ï¼š

```
æ—¶é—´çº¿:
T=0:  æ–‡æ¡£å†…å®¹ = "Hello"
T=1:  User A åœ¨æœ«å°¾æ·»åŠ  " World"  â†’  æœŸæœ›: "Hello World"
T=1:  User B åœ¨æœ«å°¾æ·»åŠ  "!"       â†’  æœŸæœ›: "Hello!"
T=2:  ???  æœ€ç»ˆç»“æœåº”è¯¥æ˜¯ä»€ä¹ˆ?
```

æ²¡æœ‰ CRDTï¼Œå¯èƒ½äº§ç”Ÿçš„é—®é¢˜ï¼š
- **æ•°æ®ä¸¢å¤±**: ååˆ°çš„æ“ä½œè¦†ç›–å…ˆåˆ°çš„
- **çŠ¶æ€ä¸ä¸€è‡´**: ä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒçš„ç»“æœ
- **æ‰‹åŠ¨å†²çªè§£å†³**: éœ€è¦ç”¨æˆ·ä»‹å…¥ï¼Œæ‰“æ–­å·¥ä½œæµ

#### 1.5.2 CRDT çš„è§£å†³æ–¹æ¡ˆ

CRDT (Conflict-free Replicated Data Types) é€šè¿‡æ•°å­¦ä¸Šå¯è¯æ˜çš„ç‰¹æ€§è§£å†³è¿™äº›é—®é¢˜ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æœ€ç»ˆä¸€è‡´æ€§** | æ— è®ºæ“ä½œä»¥ä»€ä¹ˆé¡ºåºåˆ°è¾¾ï¼Œæ‰€æœ‰å‰¯æœ¬æœ€ç»ˆ converge åˆ°ç›¸åŒçŠ¶æ€ |
| **æ— éœ€ä¸­å¤®åè°ƒ** | æ¯ä¸ªå®¢æˆ·ç«¯å¯ä»¥ç‹¬ç«‹å¤„ç†æ“ä½œï¼Œæ— éœ€ç­‰å¾…æœåŠ¡å™¨æ’åº |
| **ç¦»çº¿æ”¯æŒ** | ç”¨æˆ·å¯ä»¥åœ¨æ–­ç½‘çŠ¶æ€ä¸‹ç»§ç»­ç¼–è¾‘ï¼Œæ¢å¤åè‡ªåŠ¨åŒæ­¥æ— å†²çª |

#### 1.5.3 CRDT vs OT (Operational Transformation)

| ç‰¹æ€§ | CRDT (Yjs) | OT (Google Docs æ—©æœŸ) |
|------|------------|----------------------|
| æœåŠ¡å™¨ä¾èµ– | âŒ ä¸éœ€è¦ä¸­å¤®æœåŠ¡å™¨ | âœ… å¿…é¡»æœ‰ä¸­å¤®æœåŠ¡å™¨æ’åº |
| ç¦»çº¿æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ | âš ï¸ éœ€è¦é¢å¤–å®ç° |
| å»¶è¿Ÿ | ä½ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰ | è¾ƒé«˜ï¼ˆç­‰å¾…æœåŠ¡å™¨ï¼‰ |
| æ­£ç¡®æ€§è¯æ˜ | âœ… æ•°å­¦å¯è¯æ˜ | âš ï¸ éš¾ä»¥è¯æ˜æ—  bug |
| P2P æ”¯æŒ | âœ… å¤©ç„¶æ”¯æŒ | âŒ ä¸æ”¯æŒ |

#### 1.5.4 ç”¨æˆ·ä½“éªŒå½±å“

```
æ²¡æœ‰ CRDT:                          æœ‰ CRDT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "ç­‰å¾…æœåŠ¡å™¨å“åº”..."     â”‚          â”‚ å³æ—¶è¾“å…¥åé¦ˆï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰â”‚
â”‚ "æ‚¨çš„æ›´æ”¹ä¸ä»–äººå†²çª"    â”‚    vs    â”‚ è‡ªåŠ¨åˆå¹¶æ‰€æœ‰æ›´æ”¹       â”‚
â”‚ "ç½‘ç»œæ–­å¼€ï¼Œæ›´æ”¹å¯èƒ½ä¸¢å¤±"â”‚          â”‚ ç¦»çº¿å·¥ä½œï¼Œä¸Šçº¿è‡ªåŠ¨åŒæ­¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.6 Why PostgreSQL & Redis (æŠ€æœ¯é€‰å‹ç†ç”±)

#### 1.6.1 ä¸ºä»€ä¹ˆé€‰æ‹© PostgreSQL

| ç†ç”± | è¯¦ç»†è¯´æ˜ |
|------|----------|
| **ACID äº‹åŠ¡** | ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œæƒé™å˜æ›´ã€æ–‡æ¡£æ“ä½œéœ€è¦åŸå­æ€§ |
| **JSONB æ”¯æŒ** | è¯„è®ºçš„ `selection` å­—æ®µå­˜å‚¨ `{"anchor": 120, "head": 145}`ï¼Œæ— éœ€é¢å¤– JSON åºåˆ—åŒ– |
| **UUID åŸç”Ÿæ”¯æŒ** | åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç”Ÿæˆå”¯ä¸€ IDï¼Œæ— éœ€è‡ªå¢é” |
| **BYTEA ç±»å‹** | é«˜æ•ˆå­˜å‚¨ Yjs äºŒè¿›åˆ¶å¿«ç…§ (doc_snapshots) |
| **æˆç†Ÿçš„è¿æ¥æ± ** | pgBouncer æ”¯æŒé«˜å¹¶å‘è¿æ¥ |
| **Supabase æ‰˜ç®¡** | å…è´¹ tierï¼Œè‡ªåŠ¨å¤‡ä»½ï¼Œæ˜“äºéƒ¨ç½² |

**å…³é”®æ•°æ®éœ€æ±‚åŒ¹é…**:

```sql
-- JSONB: çµæ´»çš„è¯„è®ºé€‰åŒºå­˜å‚¨
CREATE TABLE comments (
    selection JSONB  -- {"anchor": 120, "head": 145}
);

-- BYTEA: Yjs äºŒè¿›åˆ¶çŠ¶æ€å­˜å‚¨
CREATE TABLE doc_snapshots (
    snapshot BYTEA NOT NULL  -- Yjs encodeStateAsUpdate() çš„è¾“å‡º
);

-- UUID: åˆ†å¸ƒå¼ ID ç”Ÿæˆ
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
);
```

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–æ•°æ®åº“**:

| æ•°æ®åº“ | ä¸é€‰æ‹©çš„åŸå›  |
|--------|-------------|
| MySQL | JSONB æ”¯æŒè¾ƒå¼±ï¼Œéœ€è¦ JSON_EXTRACT å‡½æ•° |
| MongoDB | ç¼ºä¹ ACID äº‹åŠ¡ï¼ˆè·¨é›†åˆï¼‰ï¼ŒäºŒè¿›åˆ¶å­˜å‚¨æ•ˆç‡è¾ƒä½ |
| SQLite | ä¸é€‚åˆå¤šå®ä¾‹éƒ¨ç½²ï¼Œå¹¶å‘å†™å…¥å—é™ |

#### 1.6.2 ä¸ºä»€ä¹ˆé€‰æ‹© Redis

| ç†ç”± | è¯¦ç»†è¯´æ˜ |
|------|----------|
| **ä¼šè¯ç¼“å­˜** | å¿«é€ŸéªŒè¯ JWT Token æœ‰æ•ˆæ€§ (O(1) æŸ¥æ‰¾) |
| **Pub/Sub é¢„ç•™** | æœªæ¥å¤šå®ä¾‹ Y-WebSocket éœ€è¦è·¨å®ä¾‹æ¶ˆæ¯å¹¿æ’­ |
| **é€Ÿç‡é™åˆ¶** | API è¯·æ±‚é¢‘ç‡æ§åˆ¶ (å¦‚ç™»å½•å°è¯•é™åˆ¶) |
| **åœ¨çº¿çŠ¶æ€** | è¿½è¸ªç”¨æˆ·åœ¨çº¿çŠ¶æ€ (é¢„ç•™åŠŸèƒ½) |
| **ä½å»¶è¿Ÿ** | å†…å­˜æ•°æ®åº“ï¼Œè¯»å†™å»¶è¿Ÿ < 1ms |

**å½“å‰ä½¿ç”¨åœºæ™¯**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å½“å‰:                                                       â”‚
â”‚  Redis ä½œä¸ºä¼šè¯å­˜å‚¨å’Œç¼“å­˜å±‚é¢„ç•™                               â”‚
â”‚                                                             â”‚
â”‚  æœªæ¥æ°´å¹³æ‰©å±•:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Y-WebSocket 1  â†â”€â”€â”€â”                                   â”‚â”‚
â”‚  â”‚  Y-WebSocket 2  â†â”€â”€â”€â”¼â”€â”€â”€ Redis Pub/Sub â”€â”€ è·¨å®ä¾‹åŒæ­¥    â”‚â”‚
â”‚  â”‚  Y-WebSocket N  â†â”€â”€â”€â”˜                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆä¸é€‰æ‹©å…¶ä»–æ–¹æ¡ˆ**:

| æ–¹æ¡ˆ | ä¸é€‰æ‹©çš„åŸå›  |
|------|-------------|
| Memcached | ä¸æ”¯æŒ Pub/Subï¼Œæ•°æ®ç»“æ„å•ä¸€ |
| ç›´æ¥ä½¿ç”¨ PostgreSQL | è½®è¯¢å¼€é”€å¤§ï¼Œå®æ—¶æ€§ä¸è¶³ |
| æ¶ˆæ¯é˜Ÿåˆ— (RabbitMQ/Kafka) | è¿‡äºé‡é‡çº§ï¼Œéƒ¨ç½²å¤æ‚ |

#### 1.6.3 æŠ€æœ¯æ ˆæ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Layer Architecture                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   PostgreSQL                      Redis                     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”€â”€â”€â”€â”€                     â”‚
â”‚   â€¢ ç”¨æˆ·æ•°æ®                       â€¢ ä¼šè¯ç¼“å­˜                â”‚
â”‚   â€¢ æ–‡æ¡£å…ƒæ•°æ®                     â€¢ é€Ÿç‡é™åˆ¶                â”‚
â”‚   â€¢ æƒé™å…³ç³»                       â€¢ Pub/Sub (é¢„ç•™)         â”‚
â”‚   â€¢ è¯„è®º (JSONB)                   â€¢ åœ¨çº¿çŠ¶æ€ (é¢„ç•™)        â”‚
â”‚   â€¢ Yjs å¿«ç…§ (BYTEA)                                        â”‚
â”‚   â€¢ è®¿é—®è¯·æ±‚                                                â”‚
â”‚                                                             â”‚
â”‚   ç‰¹ç‚¹: æŒä¹…åŒ–, ACID              ç‰¹ç‚¹: ä½å»¶è¿Ÿ, é«˜åå      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. System Design & Technical Details

### 2.1 Architecture Overview

The system follows a layered architecture with clear separation of concerns:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Next.js App â”‚  â”‚ TipTap      â”‚  â”‚ Yjs Client + Awareness  â”‚ â”‚
â”‚  â”‚ (React 18)  â”‚  â”‚ Editor      â”‚  â”‚ (WebSocket Provider)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ HTTPS           â”‚ WSS             â”‚
         â–¼                 â–¼                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   Go API Server â”‚  â”‚  Y-WebSocket    â”‚     â”‚
â”‚   (Gin)         â”‚  â”‚  Server         â”‚     â”‚
â”‚   Port: 8080    â”‚  â”‚  Port: 1234     â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
         â”‚                    â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                  â”‚                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
         â”‚   PostgreSQL    â”‚                 â”‚
         â”‚   (Supabase)    â”‚                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
```

### 2.2 Real-time Collaboration (CRDT Implementation)

#### 2.2.1 Why CRDT?

Traditional approaches like Operational Transformation (OT) require a central server to order operations, creating latency and single points of failure. CRDTs (Conflict-free Replicated Data Types) solve this by ensuring that:

1. Operations can be applied in any order
2. All replicas converge to the same state
3. No central coordination is required

#### 2.2.2 Yjs Integration

We use **Yjs**, a high-performance CRDT implementation:

```javascript
// Y-WebSocket Server (server.js)
const persistence = {
    bindState: async (docName, ydoc) => {
        // Load document from PostgreSQL on connect
        const response = await fetch(`${API_URL}/api/yjs/${docName}/snapshot`);
        if (response.ok) {
            const { snapshot } = await response.json();
            Y.applyUpdate(ydoc, Buffer.from(snapshot, 'base64'));
        }
    },
    writeState: async (docName, ydoc) => {
        // Save document to PostgreSQL on disconnect
        const snapshot = Y.encodeStateAsUpdate(ydoc);
        await fetch(`${API_URL}/api/yjs/${docName}/snapshot`, {
            method: 'POST',
            body: JSON.stringify({ snapshot: snapshot.toString('base64') })
        });
    }
};
```

**Sync Protocol**:

```
User A edits â†’ Local Yjs Doc â†’ Generate Update â†’ WebSocket â†’ Y-WebSocket Server
                                                                    â”‚
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â–¼                       â–¼
                                                   User B Client           User C Client
                                                   Apply Update            Apply Update
```

#### 2.2.3 CRDT åˆå¹¶è¿‡ç¨‹è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯: User A å’Œ User B åŒæ—¶ç¼–è¾‘ "Hello"                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   æ—¶é—´è½´ T=0:  æ–‡æ¡£åˆå§‹çŠ¶æ€ "Hello"                                           â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚               Position:  0   1   2   3   4   5                               â”‚
â”‚               Content:   H   e   l   l   o   â”‚                               â”‚
â”‚                                                                              â”‚
â”‚   æ—¶é—´è½´ T=1:  å¹¶å‘ç¼–è¾‘                                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                              â”‚
â”‚   User A æœ¬åœ°:                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Yjs Operation: Insert(" World", position=5)                        â”‚   â”‚
â”‚   â”‚  Local State: "Hello World"                                         â”‚   â”‚
â”‚   â”‚  Generate Update: [0x01, 0x05, " World", clientID_A, clock_1]       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   User B æœ¬åœ° (åŒæ—¶):                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Yjs Operation: Insert("!", position=5)                             â”‚   â”‚
â”‚   â”‚  Local State: "Hello!"                                              â”‚   â”‚
â”‚   â”‚  Generate Update: [0x01, 0x05, "!", clientID_B, clock_1]            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   æ—¶é—´è½´ T=2:  CRDT è‡ªåŠ¨åˆå¹¶                                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Yjs CRDT åˆå¹¶è§„åˆ™:                                                  â”‚   â”‚
â”‚   â”‚  â€¢ å†²çªè§£å†³: åŸºäº (clientID, clock) çš„å…¨åºæ’åˆ—                        â”‚   â”‚
â”‚   â”‚  â€¢ å‡è®¾ clientID_A < clientID_B â†’ " World" æ’åœ¨å‰é¢                  â”‚   â”‚
â”‚   â”‚  â€¢ æœ€ç»ˆçŠ¶æ€: "Hello World!"                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   User A æ”¶åˆ° B çš„ Update â†’ "Hello World" + "!" â†’ "Hello World!" âœ“          â”‚
â”‚   User B æ”¶åˆ° A çš„ Update â†’ "Hello!" + " World" â†’ "Hello World!" âœ“          â”‚
â”‚                                                                              â”‚
â”‚   âœ… ä¸¤ä¸ªç”¨æˆ·æœ€ç»ˆçŠ¶æ€ä¸€è‡´ï¼Œæ— æ•°æ®ä¸¢å¤±                                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.4 è¯„è®ºé”šç‚¹ç³»ç»Ÿæ¶æ„

è¯„è®ºç³»ç»Ÿéœ€è¦å°†è¯„è®ºä¸æ–‡æ¡£ä¸­ç‰¹å®šä½ç½®å…³è”ï¼Œå³ä½¿æ–‡æ¡£è¢«ç¼–è¾‘ä¹Ÿè¦ä¿æŒæ­£ç¡®çš„é”šå®šã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯„è®ºåˆ›å»ºæµç¨‹                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Step 1: ç”¨æˆ·é€‰æ‹©æ–‡æœ¬                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                              â”‚
â”‚   æ–‡æ¡£å†…å®¹: "è¿™æ˜¯ä¸€æ®µéœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹ï¼Œè¯·å¤§å®¶æ³¨æ„ã€‚"                          â”‚
â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                        â”‚
â”‚             â†‘ anchor=4              â†‘ head=16                                â”‚
â”‚             â”‚                       â”‚                                        â”‚
â”‚             â””â”€â”€â”€â”€â”€ é€‰ä¸­åŒºåŸŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                    "éœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹"                                        â”‚
â”‚                                                                              â”‚
â”‚   Step 2: è®°å½•é€‰åŒºä½ç½® (ProseMirror Position)                                 â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  const selection = {                                                â”‚   â”‚
â”‚   â”‚    anchor: editor.state.selection.anchor,  // 4                     â”‚   â”‚
â”‚   â”‚    head: editor.state.selection.head       // 16                    â”‚   â”‚
â”‚   â”‚  };                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   Step 3: ä¿å­˜åˆ°æ•°æ®åº“ (JSONB)                                                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                              â”‚
â”‚   POST /api/docs/:id/comments                                                â”‚
â”‚   {                                                                          â”‚
â”‚     "content": "è¿™éƒ¨åˆ†å†…å®¹éœ€è¦ä¿®æ”¹è¡¨è¿°",                                       â”‚
â”‚     "selection": { "anchor": 4, "head": 16 }                                 â”‚
â”‚   }                                                                          â”‚
â”‚                                                                              â”‚
â”‚   PostgreSQL å­˜å‚¨:                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ id           â”‚ uuid-1234-5678                                      â”‚    â”‚
â”‚   â”‚ doc_id       â”‚ doc-uuid                                            â”‚    â”‚
â”‚   â”‚ content      â”‚ "è¿™éƒ¨åˆ†å†…å®¹éœ€è¦ä¿®æ”¹è¡¨è¿°"                             â”‚    â”‚
â”‚   â”‚ selection    â”‚ {"anchor": 4, "head": 16}  â† JSONB                  â”‚    â”‚
â”‚   â”‚ resolved     â”‚ false                                               â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯„è®ºé”šç‚¹ä¸ CRDT åä½œçš„æŒ‘æˆ˜**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜: æ–‡æ¡£ç¼–è¾‘åï¼ŒåŸå§‹ä½ç½®å¯èƒ½å¤±æ•ˆ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   åˆå§‹çŠ¶æ€:                                                                   â”‚
â”‚   "è¿™æ˜¯ä¸€æ®µéœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹ï¼Œè¯·å¤§å®¶æ³¨æ„ã€‚"                                    â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                             â”‚
â”‚        4                       16  â† è¯„è®ºé”šç‚¹                                 â”‚
â”‚                                                                              â”‚
â”‚   ç”¨æˆ·åœ¨ä½ç½® 0 æ’å…¥ "ã€é‡è¦ã€‘":                                               â”‚
â”‚   "ã€é‡è¦ã€‘è¿™æ˜¯ä¸€æ®µéœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹ï¼Œè¯·å¤§å®¶æ³¨æ„ã€‚"                            â”‚
â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚
â”‚               ?                       ?  â† åŸé”šç‚¹ 4,16 ç°åœ¨æŒ‡å‘é”™è¯¯ä½ç½®!       â”‚
â”‚                                                                              â”‚
â”‚   è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ Yjs RelativePosition                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚   â€¢ åˆ›å»ºè¯„è®ºæ—¶ï¼Œå°†ç»å¯¹ä½ç½®è½¬æ¢ä¸ºç›¸å¯¹ä½ç½®                                       â”‚
â”‚   â€¢ RelativePosition ä¼šè‡ªåŠ¨è·Ÿè¸ª CRDT æ“ä½œ                                    â”‚
â”‚   â€¢ è¯»å–è¯„è®ºæ—¶ï¼Œè½¬æ¢å›æ­£ç¡®çš„ç»å¯¹ä½ç½®                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯„è®ºæ˜¾ç¤ºä¸äº¤äº’**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Editor + Comments Panel                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚         TipTap Editor              â”‚  â”‚       Comments Panel           â”‚â”‚
â”‚   â”‚                                    â”‚  â”‚                                â”‚â”‚
â”‚   â”‚  è¿™æ˜¯ä¸€æ®µ[éœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹]ï¼Œ      â”‚  â”‚  ğŸ’¬ è¯„è®º (1)           [Ã—]    â”‚â”‚
â”‚   â”‚  è¯·å¤§å®¶æ³¨æ„ã€‚                       â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚                                â”‚â”‚
â”‚   â”‚               â”‚ é«˜äº® (é»„è‰²)         â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚   â”‚               â”‚                    â”‚  â”‚  â”‚"éœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹"     â”‚   â”‚â”‚
â”‚   â”‚               â”‚                    â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚â”‚
â”‚   â”‚               â”‚    ç‚¹å‡»            â”‚  â”‚  â”‚ ğŸ‘¤ Alice Â· 5åˆ†é’Ÿå‰    â”‚   â”‚â”‚
â”‚   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”‚ è¿™éƒ¨åˆ†éœ€è¦ä¿®æ”¹è¡¨è¿°     â”‚   â”‚â”‚
â”‚   â”‚                                    â”‚  â”‚  â”‚                       â”‚â—€â”€â”€â”¤â”‚
â”‚   â”‚                                    â”‚  â”‚  â”‚  â””â”€ ğŸ‘¤ Bob: å¥½çš„      â”‚   â”‚â”‚
â”‚   â”‚                                    â”‚  â”‚  â”‚                       â”‚   â”‚â”‚
â”‚   â”‚                                    â”‚  â”‚  â”‚ [å›å¤] [âœ“è§£å†³] [ğŸ—‘ï¸]   â”‚   â”‚â”‚
â”‚   â”‚                                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                              â”‚
â”‚   äº¤äº’ç‰¹æ€§:                                                                  â”‚
â”‚   â€¢ ç‚¹å‡»é«˜äº®æ–‡æœ¬ â†’ è¯„è®ºé¢æ¿æ»šåŠ¨åˆ°å¯¹åº”è¯„è®ºå¹¶é«˜äº®                                â”‚
â”‚   â€¢ ç‚¹å‡»è¯„è®ºå¡ç‰‡ â†’ ç¼–è¾‘å™¨æ»šåŠ¨åˆ°å¯¹åº”æ–‡æœ¬ä½ç½®                                   â”‚
â”‚   â€¢ è¯„è®ºæŒ‰æ–‡æ¡£ä½ç½®æ’åºï¼Œä¸ç¼–è¾‘å™¨æ»šåŠ¨åŒæ­¥                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯„è®ºé”šç‚¹è§£æ (getQuotedText)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®æµ                                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   PostgreSQL                                                                 â”‚
â”‚   selection: {"anchor": 4, "head": 16}                                       â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   API Response â†’ Frontend                                                    â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   getQuotedText(comment, editor)                                             â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   editor.state.doc.textBetween(4, 16, ' ')                                   â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â–¼                                                                     â”‚
â”‚   è¿”å›: "éœ€è¦è®¨è®ºçš„é‡è¦å†…å®¹"  â†’ æ˜¾ç¤ºåœ¨è¯„è®ºå¡ç‰‡ä¸­                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Authentication & Authorization

#### 2.3.1 JWT-based Authentication

```go
// JWT Token Generation (Go)
func GenerateToken(user *models.User) (string, error) {
    claims := jwt.MapClaims{
        "user_id": user.ID.String(),
        "email":   user.Email,
        "exp":     time.Now().Add(24 * time.Hour).Unix(),
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    return token.SignedString([]byte(os.Getenv("JWT_SECRET")))
}
```

#### 2.3.2 Role-Based Access Control (RBAC)

| Role | View | Comment | Edit | Delete | Manage Permissions |
|------|------|---------|------|--------|-------------------|
| `view` | âœ“ | âœ— | âœ— | âœ— | âœ— |
| `comment` | âœ“ | âœ“ | âœ— | âœ— | âœ— |
| `edit` | âœ“ | âœ“ | âœ“ | âœ— | âœ— |
| `owner` | âœ“ | âœ“ | âœ“ | âœ“ | âœ“ |

**Middleware Implementation**:

```go
func RequirePermission(db *db.DB, minRole string) gin.HandlerFunc {
    return func(c *gin.Context) {
        user := GetUserFromContext(c)
        docID := c.Param("id")
        
        perm, _ := db.GetPermission(c, docID, user.ID)
        if !hasRequiredRole(perm.Role, minRole) {
            c.AbortWithStatus(403)
            return
        }
        c.Next()
    }
}
```

### 2.4 Data Model Design

```sql
-- Core Tables
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT,
    name TEXT
);

CREATE TABLE documents (
    id UUID PRIMARY KEY,
    title TEXT NOT NULL,
    owner_id UUID REFERENCES users(id),
    folder_id UUID REFERENCES folders(id)
);

CREATE TABLE doc_snapshots (
    doc_id UUID REFERENCES documents(id),
    version INTEGER,
    snapshot BYTEA NOT NULL,  -- Yjs binary state
    PRIMARY KEY (doc_id, version)
);

CREATE TABLE comments (
    id UUID PRIMARY KEY,
    doc_id UUID REFERENCES documents(id),
    user_id UUID REFERENCES users(id),
    content TEXT,
    selection JSONB,  -- {"anchor": 120, "head": 145}
    resolved BOOLEAN DEFAULT FALSE
);
```

### 2.5 Frontend Architecture

#### 2.5.1 Component Hierarchy

```
App
â”œâ”€â”€ AuthGuard (Authentication wrapper)
â”œâ”€â”€ FolderTreeSidebar (Navigation)
â”œâ”€â”€ DocumentEditor
â”‚   â”œâ”€â”€ Toolbar (Formatting buttons)
â”‚   â”œâ”€â”€ TipTapEditor (Main content area)
â”‚   â”‚   â”œâ”€â”€ Collaboration Extension (Yjs sync)
â”‚   â”‚   â””â”€â”€ CollaborationCursor Extension (User cursors)
â”‚   â”œâ”€â”€ CommentsPanel (Side panel)
â”‚   â””â”€â”€ SelectionBubbleMenu (Floating toolbar)
â””â”€â”€ ShareModal (Permission management)
```

#### 2.5.2 State Management

```typescript
// Zustand Store for Global State
interface Store {
    currentUser: User | null;
    currentDocument: Document | null;
    setCurrentUser: (user: User) => void;
}

// Yjs for Collaborative State
const ydoc = new Y.Doc();
const provider = new WebsocketProvider(WS_URL, docId, ydoc);
const yXmlFragment = ydoc.getXmlFragment('content');
```

---

## 3. Evaluation

### 3.1 Functional Testing

#### 3.1.1 Test Scenarios

| Test Case | Description | Result |
|-----------|-------------|--------|
| TC-1 | User registration and login | âœ“ Pass |
| TC-2 | Create and edit document | âœ“ Pass |
| TC-3 | Real-time collaboration (2 users) | âœ“ Pass |
| TC-4 | Real-time collaboration (3+ users) | âœ“ Pass |
| TC-5 | Permission management | âœ“ Pass |
| TC-6 | Comment creation and replies | âœ“ Pass |
| TC-7 | Document persistence after refresh | âœ“ Pass |
| TC-8 | Folder management (CRUD) | âœ“ Pass |
| TC-9 | Access request workflow | âœ“ Pass |

#### 3.1.2 Multi-User Collaboration Test

**Setup**: 3 concurrent users editing the same document

```
Timeline:
T=0s:   User A opens document
T=2s:   User B opens document
T=3s:   User A types "Hello"
T=3.1s: User B sees "Hello" appear
T=4s:   User C opens document, sees "Hello"
T=5s:   All users type simultaneously at different positions
T=5.5s: All changes merged correctly, no conflicts
```

**Observation**: Yjs CRDT successfully merged all concurrent edits without data loss or conflicts.

### 3.2 Performance Analysis

#### 3.2.1 Latency Measurements

| Operation | Average Latency | P95 Latency |
|-----------|-----------------|-------------|
| Document Load | 120ms | 250ms |
| Sync Update (local â†’ remote) | 50ms | 100ms |
| API Response (authenticated) | 80ms | 150ms |
| Comment Creation | 100ms | 200ms |

#### 3.2.2 Concurrent User Scalability

| Users | Sync Latency | Memory (Server) |
|-------|--------------|-----------------|
| 2 | 50ms | 45MB |
| 5 | 55ms | 52MB |
| 10 | 65ms | 68MB |

**Analysis**: Linear memory growth with number of active rooms, acceptable latency up to 10 concurrent users per document.

### 3.3 Comparison with Alternatives

| Feature | Our System | Google Docs | Notion |
|---------|------------|-------------|--------|
| Real-time Sync | âœ“ (Yjs/CRDT) | âœ“ (OT) | âœ“ (Custom) |
| Self-Hostable | âœ“ | âœ— | âœ— |
| Open Source | âœ“ | âœ— | âœ— |
| Offline Support | âœ“ | Partial | Partial |
| Fine-grained RBAC | âœ“ | âœ“ | âœ“ |
| Block-level Comments | âœ“ | âœ“ | âœ“ |

### 3.4 Known Limitations

1. **Scalability**: Current architecture supports ~10 concurrent users per document; horizontal scaling requires Redis pub/sub for Y-WebSocket instances.
2. **Offline Mode**: While Yjs supports offline editing, the current UI does not provide explicit offline indicators.
3. **Rich Media**: Image/video embedding is not yet implemented.

---

## 4. Artifact Description & Reproducibility

### 4.1 Repository Structure

```
two_test/
â”œâ”€â”€ frontend/                    # Next.js 14 Application
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app/                # Pages (App Router)
â”‚   â”‚   â”œâ”€â”€ components/         # React Components (12 files)
â”‚   â”‚   â”œâ”€â”€ lib/                # API client, Zustand store
â”‚   â”‚   â””â”€â”€ types/              # TypeScript definitions
â”‚   â”œâ”€â”€ package.json            # Dependencies
â”‚   â””â”€â”€ .env.local.example      # Environment template
â”‚
â”œâ”€â”€ backend/                     # Go API Server
â”‚   â”œâ”€â”€ cmd/api/                # Entrypoint
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ api/                # HTTP Handlers
â”‚   â”‚   â”œâ”€â”€ auth/               # JWT Middleware
â”‚   â”‚   â”œâ”€â”€ db/                 # Database Operations
â”‚   â”‚   â””â”€â”€ models/             # Data Models
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ go.mod                  # Go dependencies
â”‚
â”œâ”€â”€ y-websocket-server/          # Real-time Collaboration
â”‚   â”œâ”€â”€ server.js               # Custom persistence layer
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ schema.sql              # Development schema
â”‚   â””â”€â”€ schema.production.sql   # Production schema
â”‚
â”œâ”€â”€ docker-compose.yml          # Local development stack
â”œâ”€â”€ README.md                   # Setup instructions
â”œâ”€â”€ ARCHITECTURE.md             # Technical documentation
â””â”€â”€ PROJECT_REPORT.md           # This report
```

### 4.2 Environment Setup

#### 4.2.1 Prerequisites

- Docker & Docker Compose
- Node.js 18+
- Go 1.21+

#### 4.2.2 Local Development

```bash
# 1. Start infrastructure
docker-compose up -d postgres redis

# 2. Start backend
cd backend && go run ./cmd/api

# 3. Start WebSocket server
cd y-websocket-server && npm install && npm start

# 4. Start frontend
cd frontend && npm install && npm run dev
```

#### 4.2.3 Environment Variables

**Frontend (.env.local)**:
```env
NEXT_PUBLIC_API_URL=http://localhost:8080
NEXT_PUBLIC_WS_URL=ws://localhost:1234
```

**Backend (.env)**:
```env
DATABASE_URL=postgres://postgres:postgres@localhost:5432/collab_docs
JWT_SECRET=your-secret-key
PORT=8080
ALLOWED_ORIGINS=http://localhost:3000
```

### 4.3 Deployment

#### 4.3.1 Cloud Architecture

| Service | Provider | URL |
|---------|----------|-----|
| Frontend | Vercel | https://cswuncollabdocs.vercel.app/ |
| Backend API | Railway | (internal) |
| Y-WebSocket | Railway | (internal) |
| Database | Supabase | PostgreSQL 15 |
| Redis | Railway | (internal) |

#### 4.3.2 CI/CD

- **Frontend**: Automatic deployment on push to `main` via Vercel
- **Backend**: Docker-based deployment on Railway

### 4.4 Test Users

For reproducibility, pre-seeded test accounts are available:

| Email | Password | Name |
|-------|----------|------|
| alice@example.com | password123 | Alice |
| bob@example.com | password123 | Bob |
| charlie@example.com | password123 | Charlie |

### 4.5 Expected Outputs

#### 4.5.1 User Registration
```json
POST /api/auth/register
Request: { "email": "test@example.com", "password": "test123", "name": "Test" }
Response: { "token": "eyJhbGc...", "user": { "id": "...", "name": "Test" } }
```

#### 4.5.2 Document Creation
```json
POST /api/docs
Request: { "title": "My Document" }
Response: { "id": "uuid", "title": "My Document", "owner_id": "..." }
```

#### 4.5.3 Real-time Sync
When User A types, User B sees changes within ~50ms.

---

## 5. Conclusion

### 5.1 Summary

We successfully built a multi-user collaborative document system that demonstrates:

1. **Real-time Collaboration**: Using Yjs CRDT for conflict-free concurrent editing
2. **Robust Authentication**: JWT-based auth with role-based access control
3. **Full-Stack Integration**: Next.js + Go + PostgreSQL + WebSocket
4. **Production Deployment**: Live system on Vercel + Railway + Supabase

### 5.2 Key Achievements

- âœ… Functional real-time collaboration with multiple users
- âœ… Fine-grained permission management (owner/edit/comment/view)
- âœ… Text selection-based comment system
- âœ… Hierarchical folder organization
- âœ… Deployed to production with public access

### 5.3 Future Work

1. **Rich Media Support**: Image and video embedding
2. **Version History UI**: Visual diff and rollback interface
3. **Real-time Cursors**: Enhanced cursor visualization with names
4. **Mobile Optimization**: Responsive design improvements
5. **Horizontal Scaling**: Redis pub/sub for multi-instance WebSocket

---

## Appendix

### A. API Endpoints Summary

| Category | Endpoints |
|----------|-----------|
| Auth | `POST /register`, `POST /login`, `GET /me` |
| Documents | `GET /docs`, `POST /docs`, `GET/PUT/DELETE /docs/:id` |
| Permissions | `GET/PUT /docs/:id/permissions` |
| Comments | `GET/POST /docs/:id/comments`, `PUT/DELETE /comments/:id` |
| Folders | `GET/POST /folders`, `GET /folders/tree` |
| WebSocket | `WS /[docId]` (y-websocket) |

### B. Technology Stack

| Layer | Technology | Version |
|-------|------------|---------|
| Frontend | Next.js | 14.0.4 |
| Editor | TipTap | 2.1.13 |
| CRDT | Yjs | 13.6.10 |
| Backend | Go + Gin | 1.21 / 1.9.1 |
| Database | PostgreSQL | 15 |
| Hosting | Vercel + Railway + Supabase | - |

---

**Report Prepared By**: Project Team  
**Date**: December 2024  
**Repository**: [GitHub - Collaborative Document System]
