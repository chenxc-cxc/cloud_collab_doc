# System Architecture Documentation

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†å¤šç”¨æˆ·åä½œæ–‡æ¡£ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€å·¥ä½œæµç¨‹å’ŒåŠŸèƒ½è®¾è®¡ã€‚

## ç›®å½•

- [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
- [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
- [æ ¸å¿ƒå·¥ä½œæµç¨‹](#æ ¸å¿ƒå·¥ä½œæµç¨‹)
- [åŠŸèƒ½æ¨¡å—è®¾è®¡](#åŠŸèƒ½æ¨¡å—è®¾è®¡)
- [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
- [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "Frontend Layer"
        FE[Next.js 14 Frontend]
        FE --> |React Components| UI[UI Layer]
        UI --> Editor[TipTap Editor]
        UI --> Auth[AuthGuard]
        UI --> Sidebar[Folder/Comments Sidebar]
    end

    subgraph "Real-time Layer"
        YJS[Yjs CRDT]
        YWS[Y-WebSocket Server]
        YJS <--> |WebSocket| YWS
    end

    subgraph "Backend Layer"
        API[Go API Server]
        API --> Handlers[HTTP Handlers]
        API --> AuthMW[Auth Middleware]
        API --> DB_Layer[Database Layer]
    end

    subgraph "Data Layer"
        PG[(PostgreSQL)]
        Redis[(Redis)]
    end

    FE <--> |REST API| API
    FE <--> |WebSocket| YWS
    YWS <--> |Persistence API| API
    API <--> PG
    API <--> Redis
```

### å±‚æ¬¡æ¶æ„

```mermaid
graph LR
    subgraph "è¡¨ç°å±‚ Presentation"
        A[React Components]
        B[TipTap Editor]
        C[Yjs Client]
    end

    subgraph "ä¸šåŠ¡å±‚ Business"
        D[API Handlers]
        E[Auth Service]
        F[Permission Service]
    end

    subgraph "æ•°æ®å±‚ Data"
        G[PostgreSQL]
        H[Redis Cache]
    end

    subgraph "å®æ—¶å±‚ Real-time"
        I[Y-WebSocket]
        J[CRDT Sync]
    end

    A --> D
    B --> I
    C --> J
    D --> G
    D --> H
    I --> D
```

---

## éƒ¨ç½²æ¶æ„

### äº‘ç«¯éƒ¨ç½²æ¶æ„

```mermaid
graph TB
    subgraph "Client"
        Browser[Web Browser]
    end

    subgraph "Vercel"
        NextJS[Next.js Frontend<br/>SSR/CSR]
    end

    subgraph "Railway"
        GoAPI[Go API Server<br/>Port 8080]
        YWebSocket[Y-WebSocket Server<br/>Port 1234]
        RedisCloud[Redis]
    end

    subgraph "Supabase"
        PostgreSQL[(PostgreSQL<br/>Database)]
    end

    Browser <--> |HTTPS| NextJS
    Browser <--> |WSS| YWebSocket
    NextJS <--> |HTTPS| GoAPI
    YWebSocket <--> |HTTP| GoAPI
    GoAPI <--> PostgreSQL
    GoAPI <--> RedisCloud
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‹“æ‰‘ (ASCII)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client Layer                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                     â”‚    Browser     â”‚                          â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                             â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚ HTTPS        â”‚ WSS          â”‚                    â”‚
â”‚              â–¼              â”‚              â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  Next.js Frontendâ”‚      â”‚    â”‚  Y-WebSocket     â”‚          â”‚
â”‚   â”‚  (Vercel)        â”‚      â”‚    â”‚  (Railway)       â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚                â”‚             â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                â”‚             â”‚
             â”‚ HTTPS          â”‚             â”‚ HTTP (internal)
             â–¼                â”‚             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend Layer                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚            â”‚       Go API Server            â”‚                   â”‚
â”‚            â”‚       (Railway)                â”‚                   â”‚
â”‚            â”‚       Port: 8080               â”‚                   â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                        â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚              â”‚              â”‚                        â”‚
â”‚         â–¼              â–¼              â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ PostgreSQL â”‚ â”‚   Redis    â”‚ â”‚ JWT Auth   â”‚                  â”‚
â”‚  â”‚ (Supabase) â”‚ â”‚ (Railway)  â”‚ â”‚ Middleware â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Details                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Frontend (Vercel)                      â”‚
â”‚  â”‚  Next.js 14    â”‚  â† è‡ªåŠ¨ CI/CD, å…¨çƒ CDN                      â”‚
â”‚  â”‚  SSR + CSR     â”‚  â† https://cswuncollabdocs.vercel.app       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      API Server (Railway)                   â”‚
â”‚  â”‚  Go + Gin      â”‚  â† RESTful API                              â”‚
â”‚  â”‚  Port 8080     â”‚  â† JWT è®¤è¯, æƒé™æ§åˆ¶                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      WebSocket (Railway)                    â”‚
â”‚  â”‚  Y-WebSocket   â”‚  â† å®æ—¶åä½œ, CRDT åŒæ­¥                       â”‚
â”‚  â”‚  Port 1234     â”‚  â† æ–‡æ¡£æŒä¹…åŒ–åˆ° API                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Database (Supabase)                    â”‚
â”‚  â”‚  PostgreSQL 15 â”‚  â† æ‰˜ç®¡æ•°æ®åº“                                â”‚
â”‚  â”‚  + pgBouncer   â”‚  â† è¿æ¥æ±                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Cache (Railway)                        â”‚
â”‚  â”‚  Redis 7       â”‚  â† ä¼šè¯ç¼“å­˜ (é¢„ç•™)                           â”‚
â”‚  â”‚                â”‚  â† Pub/Sub (é¢„ç•™)                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœ¬åœ°å¼€å‘æ¶æ„

```mermaid
graph TB
    subgraph "Developer Machine"
        FE_Dev[npm run dev<br/>localhost:3000]
        BE_Dev[go run ./cmd/api<br/>localhost:8080]
        WS_Dev[npm start<br/>localhost:1234]
    end

    subgraph "Docker Containers"
        PG_Docker[PostgreSQL<br/>localhost:5432]
        Redis_Docker[Redis<br/>localhost:6379]
    end

    FE_Dev <--> BE_Dev
    FE_Dev <--> WS_Dev
    WS_Dev <--> BE_Dev
    BE_Dev <--> PG_Docker
    BE_Dev <--> Redis_Docker
```

---

## æ ¸å¿ƒå·¥ä½œæµç¨‹

### 1. ç”¨æˆ·è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant FE as Frontend
    participant API as Go API
    participant DB as PostgreSQL

    User->>FE: è®¿é—®ç™»å½•é¡µé¢
    User->>FE: è¾“å…¥é‚®ç®±å’Œå¯†ç 
    FE->>API: POST /api/auth/login
    API->>DB: æŸ¥è¯¢ç”¨æˆ· (email)
    DB-->>API: è¿”å›ç”¨æˆ·æ•°æ®
    API->>API: éªŒè¯å¯†ç  (bcrypt)
    API->>API: ç”Ÿæˆ JWT Token
    API-->>FE: è¿”å› {token, user}
    FE->>FE: å­˜å‚¨ token åˆ° localStorage
    FE-->>User: è·³è½¬åˆ°æ–‡æ¡£åˆ—è¡¨
```

### 2. å®æ—¶åä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User1 as ç”¨æˆ· A
    participant User2 as ç”¨æˆ· B
    participant FE1 as Frontend A
    participant FE2 as Frontend B
    participant YWS as Y-WebSocket
    participant API as Go API
    participant DB as PostgreSQL

    Note over User1,DB: æ–‡æ¡£æ‰“å¼€é˜¶æ®µ
    User1->>FE1: æ‰“å¼€æ–‡æ¡£
    FE1->>YWS: WebSocket è¿æ¥ (/docId)
    YWS->>API: GET /api/yjs/:docId/snapshot
    API->>DB: æŸ¥è¯¢æœ€æ–°å¿«ç…§
    DB-->>API: è¿”å› snapshot
    API-->>YWS: è¿”å› base64 snapshot
    YWS->>YWS: åº”ç”¨å¿«ç…§åˆ° Yjs Doc
    YWS-->>FE1: åŒæ­¥æ–‡æ¡£çŠ¶æ€

    Note over User1,DB: åä½œç¼–è¾‘é˜¶æ®µ
    User1->>FE1: ç¼–è¾‘æ–‡æ¡£å†…å®¹
    FE1->>FE1: Yjs ç”Ÿæˆ update
    FE1->>YWS: å‘é€ update
    YWS->>YWS: å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
    YWS-->>FE2: å‘é€ update
    FE2->>FE2: åº”ç”¨ update
    FE2-->>User2: æ˜¾ç¤ºæ›´æ–°å†…å®¹

    Note over User1,DB: æŒä¹…åŒ–é˜¶æ®µ
    YWS->>YWS: å®šæœŸä¿å­˜ (writeState)
    YWS->>API: POST /api/yjs/:docId/snapshot
    API->>DB: ä¿å­˜æ–°ç‰ˆæœ¬å¿«ç…§
    DB-->>API: ç¡®è®¤ä¿å­˜
```

### 3. æ–‡æ¡£æƒé™ç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Owner as æ–‡æ¡£æ‰€æœ‰è€…
    participant Viewer as è¯·æ±‚è€…
    participant FE as Frontend
    participant API as Go API
    participant DB as PostgreSQL

    Note over Owner,DB: æƒé™è¯·æ±‚é˜¶æ®µ
    Viewer->>FE: è®¿é—®æ–‡æ¡£ (æ— æƒé™)
    FE->>API: POST /api/docs/:id/access-request
    API->>DB: åˆ›å»º access_request
    DB-->>API: ç¡®è®¤åˆ›å»º
    API-->>FE: è¿”å›è¯·æ±‚çŠ¶æ€

    Note over Owner,DB: æƒé™å®¡æ‰¹é˜¶æ®µ
    Owner->>FE: æŸ¥çœ‹é€šçŸ¥é“ƒé“›
    FE->>API: GET /api/access-requests/pending
    API->>DB: æŸ¥è¯¢å¾…å¤„ç†è¯·æ±‚
    DB-->>API: è¿”å›è¯·æ±‚åˆ—è¡¨
    API-->>FE: å±•ç¤ºè¯·æ±‚åˆ—è¡¨
    Owner->>FE: æ‰¹å‡†è¯·æ±‚
    FE->>API: PUT /api/access-requests/:id
    API->>DB: æ›´æ–°è¯·æ±‚çŠ¶æ€ + åˆ›å»ºæƒé™
    DB-->>API: ç¡®è®¤æ›´æ–°
    API-->>FE: è¿”å›æˆåŠŸ

    Note over Owner,DB: è®¿é—®é˜¶æ®µ
    Viewer->>FE: å†æ¬¡è®¿é—®æ–‡æ¡£
    FE->>API: GET /api/docs/:id
    API->>DB: éªŒè¯æƒé™
    DB-->>API: æƒé™é€šè¿‡
    API-->>FE: è¿”å›æ–‡æ¡£å†…å®¹
```

### 4. è¯„è®ºç³»ç»Ÿæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant FE as Frontend
    participant Editor as TipTap Editor
    participant API as Go API
    participant DB as PostgreSQL

    User->>Editor: é€‰æ‹©æ–‡æœ¬
    Editor->>FE: æ˜¾ç¤ºé€‰æ‹©èœå•
    User->>FE: ç‚¹å‡»æ·»åŠ è¯„è®º
    FE->>FE: è®°å½•é€‰åŒºä½ç½® {anchor, head}
    User->>FE: è¾“å…¥è¯„è®ºå†…å®¹
    FE->>API: POST /api/docs/:id/comments
    Note right of API: {content, selection}
    API->>DB: åˆ›å»ºè¯„è®ºè®°å½•
    DB-->>API: è¿”å›è¯„è®º ID
    API-->>FE: è¿”å›å®Œæ•´è¯„è®º
    FE->>FE: æ›´æ–°è¯„è®ºä¾§è¾¹æ 
    FE->>Editor: é«˜äº®é€‰åŒºæ–‡æœ¬
```

---

## åŠŸèƒ½æ¨¡å—è®¾è®¡

### å‰ç«¯æ¨¡å—æ¶æ„

```mermaid
graph TB
    subgraph "Pages (App Router)"
        Home["/  - æ–‡æ¡£åˆ—è¡¨"]
        Doc["/doc/[id]  - æ–‡æ¡£ç¼–è¾‘"]
        Login["/login  - ç™»å½•"]
        Register["/register  - æ³¨å†Œ"]
    end

    subgraph "Core Components"
        AuthGuard[AuthGuard<br/>è®¤è¯å®ˆå«]
        Editor[Editor<br/>TipTap ç¼–è¾‘å™¨]
        Toolbar[Toolbar<br/>æ ¼å¼åŒ–å·¥å…·æ ]
    end

    subgraph "Feature Components"
        FolderTree[FolderTreeSidebar<br/>æ–‡ä»¶å¤¹å¯¼èˆª]
        Comments[CommentsPanel<br/>è¯„è®ºé¢æ¿]
        Share[ShareModal<br/>åˆ†äº«å¼¹çª—]
        Notify[NotificationBell<br/>é€šçŸ¥é“ƒé“›]
    end

    subgraph "State Management"
        Zustand[Zustand Store<br/>å…¨å±€çŠ¶æ€]
        Yjs[Yjs Doc<br/>åä½œçŠ¶æ€]
    end

    Home --> AuthGuard
    Doc --> AuthGuard
    Doc --> Editor
    Doc --> Toolbar
    Doc --> FolderTree
    Doc --> Comments
    Doc --> Share
    Home --> FolderTree
    Home --> Notify
```

### åç«¯æ¨¡å—æ¶æ„

```mermaid
graph TB
    subgraph "API Layer (handlers.go)"
        Auth[è®¤è¯æ¥å£<br/>Register/Login/Logout]
        Docs[æ–‡æ¡£æ¥å£<br/>CRUD]
        Perms[æƒé™æ¥å£<br/>SetPermission]
        Comments[è¯„è®ºæ¥å£<br/>CRUD]
        Folders[æ–‡ä»¶å¤¹æ¥å£<br/>CRUD/Tree]
        Access[è®¿é—®è¯·æ±‚æ¥å£<br/>Request/Approve]
        Yjs[Yjs æ¥å£<br/>Snapshot]
    end

    subgraph "Middleware Layer"
        AuthMW[AuthMiddleware<br/>JWT éªŒè¯]
        PermMW[RequirePermission<br/>æƒé™æ£€æŸ¥]
    end

    subgraph "Data Layer (db/)"
        UserDB[ç”¨æˆ·æ“ä½œ]
        DocDB[æ–‡æ¡£æ“ä½œ]
        PermDB[æƒé™æ“ä½œ]
        CommentDB[è¯„è®ºæ“ä½œ]
        FolderDB[æ–‡ä»¶å¤¹æ“ä½œ]
        SnapshotDB[å¿«ç…§æ“ä½œ]
    end

    Auth --> AuthMW
    Docs --> AuthMW --> PermMW
    Perms --> AuthMW --> PermMW
    Comments --> AuthMW --> PermMW
    Folders --> AuthMW
    Access --> AuthMW
    Yjs --> SnapshotDB

    AuthMW --> UserDB
    PermMW --> PermDB
    Docs --> DocDB
    Comments --> CommentDB
    Folders --> FolderDB
```

### æ•°æ®åº“æ¨¡å‹å…³ç³»

```mermaid
erDiagram
    users ||--o{ documents : owns
    users ||--o{ folders : owns
    users ||--o{ comments : writes
    users ||--o{ document_permissions : has
    users ||--o{ access_requests : creates

    documents ||--o{ document_permissions : has
    documents ||--o{ comments : contains
    documents ||--o{ doc_snapshots : has_versions
    documents }o--|| folders : belongs_to

    folders ||--o{ folders : contains

    comments ||--o{ comments : replies_to

    users {
        uuid id PK
        string email UK
        string password_hash
        string name
        string avatar_url
        timestamp created_at
        timestamp updated_at
    }

    documents {
        uuid id PK
        string title
        uuid owner_id FK
        uuid folder_id FK
        timestamp created_at
        timestamp updated_at
    }

    folders {
        uuid id PK
        string name
        uuid owner_id FK
        uuid parent_id FK
        timestamp created_at
        timestamp updated_at
    }

    document_permissions {
        uuid doc_id PK,FK
        uuid user_id PK,FK
        string role
        timestamp created_at
    }

    doc_snapshots {
        uuid doc_id PK,FK
        int version PK
        bytea snapshot
        timestamp created_at
    }

    comments {
        uuid id PK
        uuid doc_id FK
        uuid user_id FK
        string content
        jsonb selection
        bool resolved
        uuid parent_id FK
        timestamp created_at
        timestamp updated_at
    }

    access_requests {
        uuid id PK
        uuid doc_id FK
        uuid requester_id FK
        string status
        string requested_role
        string message
        timestamp created_at
        timestamp updated_at
    }
```

---

## æ•°æ®æµè®¾è®¡

### å‰ç«¯çŠ¶æ€ç®¡ç†

```mermaid
graph LR
    subgraph "Local State"
        Component[React Component State]
    end

    subgraph "Global State (Zustand)"
        User[currentUser]
        Doc[currentDocument]
        Perms[permissions]
    end

    subgraph "Collaborative State (Yjs)"
        YDoc[Y.Doc]
        YText[Y.XmlFragment]
        Awareness[Awareness Protocol]
    end

    subgraph "Server State"
        API[REST API]
        WS[WebSocket]
    end

    Component --> User
    Component --> Doc
    API --> User
    API --> Doc
    API --> Perms
    WS <--> YDoc
    YDoc --> YText
    YDoc --> Awareness
```

### API è¯·æ±‚æµç¨‹

```mermaid
graph TB
    subgraph "Frontend"
        Client[API Client]
        Store[Zustand Store]
    end

    subgraph "Network"
        Request[HTTP Request]
        Response[HTTP Response]
    end

    subgraph "Backend"
        Router[Gin Router]
        Auth[Auth Middleware]
        Perm[Permission Check]
        Handler[Handler]
        DB[Database]
    end

    Client -->|fetch| Request
    Request --> Router
    Router --> Auth
    Auth -->|token valid| Perm
    Auth -->|token invalid| Response
    Perm -->|has access| Handler
    Perm -->|no access| Response
    Handler --> DB
    DB --> Handler
    Handler --> Response
    Response --> Client
    Client --> Store
```

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### JWT è®¤è¯æœºåˆ¶

```mermaid
graph LR
    subgraph "Login Flow"
        A[ç”¨æˆ·ç™»å½•] --> B[æœåŠ¡å™¨éªŒè¯]
        B --> C[ç”Ÿæˆ JWT]
        C --> D[è¿”å› Token]
    end

    subgraph "JWT Structure"
        E[Header<br/>Algorithm]
        F[Payload<br/>user_id, exp]
        G[Signature<br/>HMAC-SHA256]
    end

    subgraph "Request Flow"
        H[API è¯·æ±‚] --> I[Authorization Header]
        I --> J[ä¸­é—´ä»¶éªŒè¯]
        J --> K[è§£æç”¨æˆ·ä¿¡æ¯]
        K --> L[å¤„ç†è¯·æ±‚]
    end
```

### CRDT åŒæ­¥æœºåˆ¶

```mermaid
graph TB
    subgraph "Client A"
        A1[Local Yjs Doc]
        A2[ç¼–è¾‘æ“ä½œ]
        A1 --> A2
        A2 --> A3[ç”Ÿæˆ Update]
    end

    subgraph "Y-WebSocket Server"
        S1[æ¥æ”¶ Update]
        S2[å¹¿æ’­ Update]
        S3[åˆå¹¶çŠ¶æ€]
        S1 --> S2
        S1 --> S3
    end

    subgraph "Client B"
        B1[æ¥æ”¶ Update]
        B2[åº”ç”¨ Update]
        B3[Local Yjs Doc]
        B1 --> B2
        B2 --> B3
    end

    A3 -->|WebSocket| S1
    S2 -->|WebSocket| B1
```

### å®æ—¶åä½œè¯¦ç»†æ¶æ„ (Yjs / CRDT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Real-time Collaboration Architecture                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Y-WebSocket   â”‚
                              â”‚     Server      â”‚
                              â”‚  (Railway)      â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Room: doc1  â”‚  â”‚   Room: doc2  â”‚  â”‚   Room: docN  â”‚
            â”‚   (Y.Doc)     â”‚  â”‚   (Y.Doc)     â”‚  â”‚   (Y.Doc)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User A  â”‚ â”‚ User B  â”‚ â”‚ User C  â”‚
   â”‚ Client  â”‚ â”‚ Client  â”‚ â”‚ Client  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚        Yjs Client Library       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚  Y.Doc                          â”‚
   â”‚  â”œâ”€â”€ Y.XmlFragment (content)    â”‚  â† TipTap ç¼–è¾‘å™¨å†…å®¹
   â”‚  â”œâ”€â”€ Y.Map (meta)               â”‚  â† æ–‡æ¡£å…ƒæ•°æ®
   â”‚  â””â”€â”€ Awareness                  â”‚  â† ç”¨æˆ·å…‰æ ‡/é€‰åŒº
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CRDT Sync Flow                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   User A ç¼–è¾‘                                                               â”‚
â”‚      â”‚                                                                      â”‚
â”‚      â–¼                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ 1. æœ¬åœ°ä¿®æ”¹       â”‚ â”€â”€â–¶ â”‚ 2. ç”Ÿæˆ Update   â”‚ â”€â”€â–¶ â”‚ 3. å‘é€åˆ°æœåŠ¡å™¨  â”‚   â”‚
â”‚   â”‚    Y.Doc         â”‚     â”‚    (äºŒè¿›åˆ¶)       â”‚     â”‚    WebSocket     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚             â”‚
â”‚                                                               â–¼             â”‚
â”‚                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                                                    â”‚ 4. Y-WebSocket   â”‚     â”‚
â”‚                                                    â”‚    å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·â”‚     â”‚
â”‚                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                               â”‚             â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚                      â”‚                                        â”‚             â”‚
â”‚                      â–¼                                        â–¼             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚ 5. User B æ”¶åˆ°    â”‚                         â”‚ 5. User C æ”¶åˆ°   â”‚        â”‚
â”‚   â”‚    åº”ç”¨ Update    â”‚                         â”‚    åº”ç”¨ Update   â”‚        â”‚
â”‚   â”‚    è‡ªåŠ¨åˆå¹¶       â”‚                         â”‚    è‡ªåŠ¨åˆå¹¶      â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Awareness Protocol (å…‰æ ‡åŒæ­¥)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   User A    â”‚         â”‚   User B    â”‚         â”‚   User C    â”‚          â”‚
â”‚   â”‚  ğŸ”µ è“è‰²å…‰æ ‡ â”‚         â”‚  ğŸŸ¢ ç»¿è‰²å…‰æ ‡ â”‚         â”‚  ğŸŸ  æ©™è‰²å…‰æ ‡ â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                       â”‚                       â”‚                  â”‚
â”‚          â–¼                       â–¼                       â–¼                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚                    Awareness State                          â”‚          â”‚
â”‚   â”‚  {                                                          â”‚          â”‚
â”‚   â”‚    "user": { "name": "Alice", "color": "#3b82f6" },         â”‚          â”‚
â”‚   â”‚    "cursor": { "anchor": 120, "head": 120 },                â”‚          â”‚
â”‚   â”‚    "selection": null                                        â”‚          â”‚
â”‚   â”‚  }                                                          â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Persistence Flow                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚  Document    â”‚      â”‚  Y-WebSocket â”‚      â”‚   Go API     â”‚             â”‚
â”‚   â”‚  æ‰“å¼€æ—¶       â”‚ â”€â”€â”€â–¶ â”‚  bindState   â”‚ â”€â”€â”€â–¶ â”‚  GET snapshotâ”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                       â”‚                     â”‚
â”‚                                                       â–¼                     â”‚
â”‚                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                                               â”‚  PostgreSQL  â”‚             â”‚
â”‚                                               â”‚  doc_snapshotsâ”‚             â”‚
â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚  æ‰€æœ‰ç”¨æˆ·     â”‚      â”‚  Y-WebSocket â”‚      â”‚   Go API     â”‚             â”‚
â”‚   â”‚  æ–­å¼€è¿æ¥     â”‚ â”€â”€â”€â–¶ â”‚  writeState  â”‚ â”€â”€â”€â–¶ â”‚ POST snapshotâ”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯„è®ºç³»ç»Ÿ & ç¼–è¾‘å™¨å†…éƒ¨ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TipTap Editor & Comments Architecture                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Editor Page Layout                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚             â”‚  â”‚                                â”‚  â”‚                 â”‚ â”‚
â”‚   â”‚   Folder    â”‚  â”‚        TipTap Editor           â”‚  â”‚    Comments     â”‚ â”‚
â”‚   â”‚    Tree     â”‚  â”‚                                â”‚  â”‚     Panel       â”‚ â”‚
â”‚   â”‚  Sidebar    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚                 â”‚ â”‚
â”‚   â”‚             â”‚  â”‚   â”‚       Toolbar          â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚  B I U S H1 H2 â€¢ â—‹ âœ“   â”‚   â”‚  â”‚  â”‚ Comment 1 â”‚ â”‚ â”‚
â”‚   â”‚  â”‚ ğŸ“ Docsâ”‚  â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚ "é€‰ä¸­æ–‡æœ¬" â”‚ â”‚ â”‚
â”‚   â”‚  â”‚ ğŸ“ Workâ”‚  â”‚  â”‚                                â”‚  â”‚  â”‚ @Alice    â”‚ â”‚ â”‚
â”‚   â”‚  â”‚  â”” ğŸ“„ Aâ”‚  â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚   â”‚  â”‚  â”” ğŸ“„ Bâ”‚  â”‚  â”‚   â”‚                        â”‚   â”‚  â”‚                 â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚   Document Content      â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚   â”‚             â”‚  â”‚   â”‚                        â”‚   â”‚  â”‚  â”‚ Comment 2 â”‚ â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   è¿™æ˜¯ä¸€æ®µ[é«˜äº®æ–‡æœ¬]...  â”‚   â”‚  â”‚  â”‚ "å¦ä¸€æ®µ"  â”‚ â”‚ â”‚
â”‚                    â”‚   â”‚                        â”‚   â”‚  â”‚  â”‚ @Bob      â”‚ â”‚ â”‚
â”‚                    â”‚   â”‚   More content here... â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                    â”‚   â”‚                        â”‚   â”‚  â”‚                 â”‚ â”‚
â”‚                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚                                â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TipTap Editor Internal Structure                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                          â”‚    useEditor Hook   â”‚                            â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                     â”‚                                       â”‚
â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚               â”‚                     â”‚                     â”‚                â”‚
â”‚               â–¼                     â–¼                     â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   Extensions    â”‚   â”‚   Y.XmlFragment â”‚   â”‚    Awareness    â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚                     â”‚                     â”‚                   â”‚
â”‚            â–¼                     â–¼                     â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚                    Installed Extensions                      â”‚          â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚   â”‚  @tiptap/starter-kit     â”‚  åŸºç¡€ç¼–è¾‘åŠŸèƒ½ (Bold, Italic, List)â”‚          â”‚
â”‚   â”‚  @tiptap/collaboration   â”‚  Yjs åä½œé›†æˆ                    â”‚          â”‚
â”‚   â”‚  @tiptap/collab-cursor   â”‚  å¤šç”¨æˆ·å…‰æ ‡æ˜¾ç¤º                   â”‚          â”‚
â”‚   â”‚  @tiptap/bubble-menu     â”‚  é€‰åŒºæµ®åŠ¨èœå•                    â”‚          â”‚
â”‚   â”‚  @tiptap/placeholder     â”‚  å ä½ç¬¦æ–‡æœ¬                      â”‚          â”‚
â”‚   â”‚  @tiptap/highlight       â”‚  æ–‡æœ¬é«˜äº® (è¯„è®ºæ ‡è®°)              â”‚          â”‚
â”‚   â”‚  @tiptap/underline       â”‚  ä¸‹åˆ’çº¿æ ¼å¼                      â”‚          â”‚
â”‚   â”‚  @tiptap/task-list       â”‚  ä»»åŠ¡åˆ—è¡¨                        â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Comment System Flow                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        1. é€‰æ‹©æ–‡æœ¬                                 â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚                         â”‚
â”‚                                                   â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  SelectionBubbleMenu.tsx                                          â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚   â”‚  â”‚  ğŸ’¬ æ·»åŠ è¯„è®º  â”‚  B  â”‚  I  â”‚  U  â”‚  H1  â”‚  H2  â”‚  â€¢  â”‚      â”‚  â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚                         â”‚
â”‚                                                   â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        2. è®°å½•é€‰åŒºä½ç½®                             â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚   selection = {                                                   â”‚    â”‚
â”‚   â”‚     anchor: editor.state.selection.anchor,  // èµ·å§‹ä½ç½®           â”‚    â”‚
â”‚   â”‚     head: editor.state.selection.head       // ç»“æŸä½ç½®           â”‚    â”‚
â”‚   â”‚   }                                                               â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚                         â”‚
â”‚                                                   â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        3. è¾“å…¥è¯„è®ºå†…å®¹                             â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚   â”‚   â”‚  è¯„è®ºè¾“å…¥æ¡†                                              â”‚     â”‚    â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚    â”‚
â”‚   â”‚   â”‚  â”‚ è¯·è¾“å…¥æ‚¨çš„è¯„è®º...                                   â”‚  â”‚     â”‚    â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚    â”‚
â”‚   â”‚   â”‚                                        [ å–æ¶ˆ ] [ æäº¤ ] â”‚     â”‚    â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚                         â”‚
â”‚                                                   â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        4. ä¿å­˜åˆ°æ•°æ®åº“                             â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚   POST /api/docs/:id/comments                                     â”‚    â”‚
â”‚   â”‚   {                                                               â”‚    â”‚
â”‚   â”‚     "content": "è¿™æ®µæ–‡å­—éœ€è¦ä¿®æ”¹",                                  â”‚    â”‚
â”‚   â”‚     "selection": { "anchor": 120, "head": 145 }                   â”‚    â”‚
â”‚   â”‚   }                                                               â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚                         â”‚
â”‚                                                   â–¼                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        5. æ›´æ–° UI                                  â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚   â€¢ è¯„è®ºä¾§è¾¹æ æ·»åŠ æ–°è¯„è®ºå¡ç‰‡                                        â”‚    â”‚
â”‚   â”‚   â€¢ ç¼–è¾‘å™¨ä¸­é«˜äº®è¢«è¯„è®ºçš„æ–‡æœ¬                                        â”‚    â”‚
â”‚   â”‚   â€¢ ç‚¹å‡»é«˜äº®æ–‡æœ¬ â†’ æ»šåŠ¨åˆ°å¯¹åº”è¯„è®º                                   â”‚    â”‚
â”‚   â”‚   â€¢ ç‚¹å‡»è¯„è®ºå¡ç‰‡ â†’ æ»šåŠ¨åˆ°å¯¹åº”æ–‡æœ¬ä½ç½®                               â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Comment Data Structure                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   comments Table                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  id          â”‚ UUID        â”‚ è¯„è®ºå”¯ä¸€æ ‡è¯†                           â”‚  â”‚
â”‚   â”‚  doc_id      â”‚ UUID        â”‚ æ‰€å±æ–‡æ¡£ ID                            â”‚  â”‚
â”‚   â”‚  user_id     â”‚ UUID        â”‚ è¯„è®ºè€… ID                              â”‚  â”‚
â”‚   â”‚  content     â”‚ TEXT        â”‚ è¯„è®ºå†…å®¹                               â”‚  â”‚
â”‚   â”‚  selection   â”‚ JSONB       â”‚ { "anchor": 120, "head": 145 }        â”‚  â”‚
â”‚   â”‚  resolved    â”‚ BOOLEAN     â”‚ æ˜¯å¦å·²è§£å†³                             â”‚  â”‚
â”‚   â”‚  parent_id   â”‚ UUID (NULL) â”‚ çˆ¶è¯„è®º ID (å›å¤åŠŸèƒ½)                    â”‚  â”‚
â”‚   â”‚  created_at  â”‚ TIMESTAMP   â”‚ åˆ›å»ºæ—¶é—´                               â”‚  â”‚
â”‚   â”‚  updated_at  â”‚ TIMESTAMP   â”‚ æ›´æ–°æ—¶é—´                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   Comment Thread Structure                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Comment (parent_id = NULL)                                         â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Reply 1 (parent_id = comment.id)                               â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ Reply 2 (parent_id = comment.id)                               â”‚  â”‚
â”‚   â”‚  â””â”€â”€ Reply 3 (parent_id = comment.id)                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Comments Panel Component Structure                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   CommentsPanel.tsx                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚   â”‚  Header (å›ºå®š)                                               â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  ğŸ’¬ è¯„è®º (3)                              [ å…³é—­æŒ‰é’® ]   â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚   â”‚  Comments List (å¯æ»šåŠ¨, ä¸ç¼–è¾‘å™¨åŒæ­¥)                         â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  CommentCard                                            â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚ "è¢«å¼•ç”¨çš„æ–‡æœ¬..."                                    â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚ ğŸ‘¤ Alice Â· 2 åˆ†é’Ÿå‰                                 â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚ è¿™æ®µéœ€è¦ä¿®æ”¹ä¸€ä¸‹                                     â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚                                                     â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚ â””â”€â”€ ğŸ‘¤ Bob: å¥½çš„ï¼Œæˆ‘æ¥æ”¹                             â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â”‚                          [ å›å¤ ] [ âœ“ è§£å†³ ] [ ğŸ—‘ï¸ ] â”‚â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚                                                             â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â”‚  CommentCard (æ›´å¤šè¯„è®º...)                               â”‚ â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æƒé™æ§åˆ¶æ¨¡å‹

```mermaid
graph TB
    subgraph "Permission Levels"
        Owner[Owner<br/>å®Œå…¨æ§åˆ¶]
        Edit[Edit<br/>è¯»å†™æƒé™]
        Comment[Comment<br/>è¯„è®ºæƒé™]
        View[View<br/>åªè¯»æƒé™]
    end

    subgraph "Capabilities"
        Delete[åˆ é™¤æ–‡æ¡£]
        ManagePerm[ç®¡ç†æƒé™]
        EditDoc[ç¼–è¾‘å†…å®¹]
        AddComment[æ·»åŠ è¯„è®º]
        ReadDoc[é˜…è¯»æ–‡æ¡£]
    end

    Owner --> Delete
    Owner --> ManagePerm
    Owner --> EditDoc
    Owner --> AddComment
    Owner --> ReadDoc

    Edit --> EditDoc
    Edit --> AddComment
    Edit --> ReadDoc

    Comment --> AddComment
    Comment --> ReadDoc

    View --> ReadDoc
```

---

## å®‰å…¨è®¾è®¡

### å®‰å…¨æªæ–½

| å±‚é¢ | æªæ–½ | å®ç° |
|------|------|------|
| ä¼ è¾“å±‚ | HTTPS/WSS | Vercel/Railway é»˜è®¤ SSL |
| è®¤è¯å±‚ | JWT Token | Bearer Token + è¿‡æœŸç­–ç•¥ |
| æˆæƒå±‚ | RBAC | ä¸­é—´ä»¶æƒé™æ£€æŸ¥ |
| æ•°æ®å±‚ | å‚æ•°åŒ–æŸ¥è¯¢ | pgx é¢„ç¼–è¯‘è¯­å¥ |
| å¯†ç å®‰å…¨ | bcrypt å“ˆå¸Œ | golang.org/x/crypto |
| CORS | åŸŸåç™½åå• | gin-contrib/cors |

### è¯·æ±‚è®¤è¯æµç¨‹

```mermaid
graph TB
    A[HTTP Request] --> B{Authorization Header?}
    B -->|No| C[401 Unauthorized]
    B -->|Yes| D{Token Valid?}
    D -->|No| E[401 Token Invalid]
    D -->|Yes| F{Permission Check}
    F -->|Pass| G[Process Request]
    F -->|Fail| H[403 Forbidden]
```

---

## æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•æ–¹æ¡ˆ

```mermaid
graph TB
    subgraph "Load Balancer"
        LB[Nginx / Cloud LB]
    end

    subgraph "API Servers"
        API1[Go API Instance 1]
        API2[Go API Instance 2]
        API3[Go API Instance N]
    end

    subgraph "WebSocket Servers"
        WS1[Y-WebSocket 1]
        WS2[Y-WebSocket 2]
    end

    subgraph "Data Layer"
        PG[(PostgreSQL<br/>Primary)]
        PG_R[(PostgreSQL<br/>Replica)]
        Redis[(Redis Cluster)]
    end

    LB --> API1
    LB --> API2
    LB --> API3
    LB --> WS1
    LB --> WS2

    API1 --> PG
    API2 --> PG
    API3 --> PG
    PG --> PG_R

    API1 --> Redis
    WS1 --> Redis
    WS2 --> Redis
```

---

## æ€»ç»“

æœ¬ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œç»“åˆ CRDT æŠ€æœ¯å®ç°å®æ—¶åä½œï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **é«˜å¯ç”¨æ€§**: å‰åç«¯ç‹¬ç«‹éƒ¨ç½²ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
2. **å®æ—¶åä½œ**: åŸºäº Yjs/CRDT çš„æ— å†²çªç¼–è¾‘
3. **å®‰å…¨å¯é **: å®Œæ•´çš„è®¤è¯æˆæƒæœºåˆ¶
4. **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œï¼Œæ˜“äºç»´æŠ¤æ‰©å±•
5. **ç”¨æˆ·ä½“éªŒ**: ç°ä»£åŒ– UIï¼Œæµç•…çš„äº¤äº’ä½“éªŒ
